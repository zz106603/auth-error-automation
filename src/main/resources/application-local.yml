spring:
  flyway:
    enabled: true

  datasource:
    url: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 16
      minimum-idle: 8
      connection-timeout: 2000
      validation-timeout: 1000
      idle-timeout: 600000
      max-lifetime: 1800000

  rabbitmq:
    host: ${RABBIT_HOST}
    port: ${RABBIT_PORT}
    username: ${RABBIT_USERNAME}
    password: ${RABBIT_PASSWORD}
    virtual-host: ${RABBIT_VHOST:/}
    dynamic: true
    publisher-confirm-type: correlated # publish 후 ack / nack 받기
    publisher-returns: true # 라우팅 실패 시 return callback
    template:
      mandatory: true # 큐 없으면 유실 말고 return
    listener:
      simple:
        acknowledge-mode: manual
        default-requeue-rejected: false
        auto-startup: true # outbox/consumer 로직 완성 전에는 자동 소비 방지
        concurrency: 4
        max-concurrency: 4
        prefetch: 25

outbox:
  owner: ${POD_NAME:}

  poller:
    batch-size: 100
    fixed-delay-ms: 200

  retry:
    max-retries: 6
    delay-seconds: 5

  reaper:
    stale-after-seconds: 300
    batch-size: 100
    fixed-delay-ms: 5000

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env,configprops,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    distribution:
      percentiles-histogram:
        http.server.requests: true
        auth_error.e2e: true
        auth_error.outbox.age: true
      percentiles:
        http.server.requests: 0.95,0.99
        auth_error.e2e: 0.95,0.99
        auth_error.outbox.age: 0.95,0.99

metrics:
  # outbox/mq 지표 수집 (테스트 기본 OFF)
  outbox-age:
    enabled: true
  rabbit:
    enabled: true

rabbitmq:
  management:
    # MQ 상태 수집용 (환경변수로 주입)
    base-url: ${RABBIT_MGMT_URL}
    username: ${RABBIT_USERNAME}
    password: ${RABBIT_PASSWORD}
    vhost: ${RABBIT_VHOST:/}

auth-error:
  source-service: ${spring.application.name}
  environment: local
  rabbit:
    retry:
      ttl-short: 5000
      ttl-medium: 30000
      ttl-long: 60000
      fast-max: 2
      medium-max: 4

logging:
  level:
    root: WARN
    com.yunhwan.auth.error.infra.logging.AuthErrorEventLogger: INFO
    com.yunhwan.auth.error.infra.messaging.consumer.listener: INFO
